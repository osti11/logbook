\documentclass[a4paper]{article}

\usepackage[T1]{fontenc}
\usepackage{newtxtext}     %TimesNewRoman
\usepackage[utf8]{inputenc} %UTF-8 Zeichensatz
\usepackage[ngerman]{babel} %Deutsch
\usepackage{lmodern}
\usepackage{pdfpages}
\usepackage{graphicx}   %Grafik einfuegen
\usepackage{float}      %Grafik fest positionieren
\usepackage{scrlayer-scrpage}   %Paket Kopf-/Fußzeile
\usepackage{csquotes}
%\setcounter{tocdepth}{2}

\author{Jannik Ostermayer}

\begin{document}

\pagestyle{scrheadings}         %Kopf und Fußzeile mit Paket setzen
\clearpairofpagestyles          %Kopf & Fuß leeren
%footer
\ifoot{Jannik Ostermayer}
\cfoot{Matr.Nr. 672330}
\ofoot{\pagemark}

\begin{titlepage}

	\centering
	\includegraphics[width=0.4\textwidth]{img/Logo_HS_Worms.png}\par\vspace{1cm}
	{\LARGE Entwicklung mobiler Anwendungen \par}
	\vspace{1.5cm}
	{\huge Projekt Fahrtenbuch\par}
	\vspace{0.3cm}
	{\huge Dokumentation\par}
	\vspace{2cm}
	{\Large Jannik Ostermayer\par}
	\vspace{1cm}
	{ Matrikelnummer 672330 \par}
	\vfill

% Bottom of the page
	{\large \today\par}

\end{titlepage}

\tableofcontents    %Inhaltsverzeichnis
\pagebreak          %Seitenumbruch

\section{Idee}
Meine Idee ist eine Fahrtenbuchapp zum leichten Übertragen 
der Fahrten in ein physisches Fahrtenbuch.
Da es noch keine verifizierte Fahrtenbuchapp 
des Finanzamtes gibt und so auch keine Rechtssicherheit herrscht.
Zum leichteren übertragen sollte es auch eine Exportfunktion geben oder
die Möglichleit sich eine Email zu schicken.
Da das übertragen in ein Fahrtenbuch zeitnahgeschehen (innerhalb der 
nächsten drei Tage) erfolgen muss sollte es auch Push Benachrichtungen
zur Erinnerung geben. Die App kann durch einen Button gestartet werden,
aber auch alternativ durch eine Bluetooth Verbindung oder einen NFC Chip.
Die erfassten Fahrten sollten auch auf einer Karte angezeigt werden,
da man bei größeren Umwegen, diese genau beschreiben muss.

\section{Beschreibung}
Diese App vereinfacht das führen eines Fahrtenbuches enorm. 
Alle Fahrten werden erfasst und du wirst Benachrichtigt, dass du dein 
Fahrtenahrtenbuch zeitnah führen kannst. 
Außerdem gibt es Export-Funktionen das du dir deine erfassetn Fahrten 
auch bequem auf deinem PC anschauen kannst.

\section{Zielgruppe}
Der potentielle Markt für eine Fahrtenbuch App erstreckt sich über alle
gewerblich genutzt Fahrzeuge in Deutschland. Das sind laut einer Statistik des KBA (Kraft Fahrt Bundesamtes)
aus dem Jahr 2017 64,4\% der zugelassenen Fahrzeuge in Deutschland. In absoluten Zahlen sind das 2.215.208
Gewerblich neu zugelassen Fahrzeuge. Meine App richtet sich aber spezial an Personen die einen
Firmenwagen fahren, wie Vertreter. Da es bei den Statistiken nur eine unterscheidung zwischen
geschäftlicher und privater Nutzung gibt, exestieren keine genauen Zahlen über Anzahl der Firmenwagen
unter den gewerblich genutzten Fahrzeugen. Man geht von ca 10\% der gesamten Fahrzeuge aus.
Laut KBA vom Stand 1. Januar 2018 gibt es in Deutschland 46,5 Millionen zugelessene PKWs.
Das bedeutet wenn man von 10\% ausgeht, gibt es in Deutschland 4,65 Millionen Firmenfahrzeuge.
Da sich meine App an Fahrer eines Firmenwagens richtet die Steuern sparen wollen und eine
erleichterung beim führen eines Fahrtenbuches suchen, trifft meine App auf einen potentiellen
Markt von 4,65 Millionen nutzern. Bei dem Führen von Fahrtenbüchern gibt es starke unterschiede
zwischen den Berufsgruppen, so muss zum Beispiel ein Handwerker für jede Fahrt den Grund der Fahrt angeben.
Dahingegen müssen Handelsvertreter und Kundendienstmonteure keinen Grund der Fahrt angeben, wenn der Grund
plausibel ist, hier reicht wenn der Kunde angegeben wird. Bei diesen Berufsgruppen die nicht alles angeben
müssen spricht man von einem \textit{erleichterten} Fahrtenbuch. In erste Linie soll sich meine App an Personen
die ein solches \textit{erleichtertes} Fahrtenbuch führen richten. Im nächsten Schritt, wenn meine App ausgebaut wird
würde ich auch gerne die anderen Berufsgruppen, die ein \textit{normales} Fahrtenbuch führen in
meine Zielgruppe mitaufnehmen.

%Grafik
%\begin{figure}[H]
%    \begin{center}
%        \includegraphics[width=12cm]{neuzulassung.jpg}
%        \caption{Verteilung der neuzugelassenen Fahrzeuge}
%        \label{Verteilung der neuzugelassenen Fahrzeuge}
%    \end{center}
%\end{figure}

\input{marketAnalysis.tex}

\section{Bedarfsanalyse}

\subsection{Fahrt hinzufügen}
In der App soll man in einer Suchleiste die Startaddresse eingeben und in einer anderen die Zieladdresse.
Zur Autovervollständigung der Adresse werde ich die Google Places API verwenden.

\subsection{gefahrene Strecke auf Karte anzeigen}
Dafür werde ich die Google Maps SDK verwenden.

\subsection{Datenbank}

 \begin{table}
	\caption{Spalten des Fahrtenbuches}
    \centering
	\begin{tabular}{c c c c c c c c c c c c c}
		\hline
		Datum & Fahrzeit von - bis & Zweck der Fahrt  & Besuchte Person, Firma, Behörde &
		km-Stand Fahrtbeginn & Gefahrene km & Start & Ziel & km-Satnd Fahrtende & Ktaftstoff &
		Ltr. je 100km & Sonstiger Betrag & Name des Fahrers\\ [0.5ex]
		1 & Home & HS & lernen \\ [1ex]
		\hline
	\end{tabular}
	\label{table:nonlin}
 \end{table}

 \begin{table}
	\caption{Aufbau Datenbank}
    \centering
	\begin{tabular}{c c c c c c c c c c c c c}
		\hline
        id & start & destination & purpose & mileage_start & mileage_destination & odometer \\ [1ex]
		\hline
	\end{tabular}
	\label{table:nonlin}
 \end{table}

\subsection{Aufzeichnen Der Fahrt}
Um die Fahrt aufzuzeichnen

\subsubsection{Position bestimmen}
Um die Position unter Android zu ermitteln gibt es drei Wege:
\begin{enumerate}
	\item  LocationManager & LocationListener
	\item fusion location client
	\item fusion location provider
\end{enumerate}

LocationManager & LocationListener
Bei dieser Möglichkeit werden die Boardmittel von ANdroid verwendet um die Position bestimmen.
Diese Methode hat den größten Akkuverbrauch und wird von Google nicht empfohlen.

Fusion Location client
Bei dieser Methode wird der Google Location Service verwendet der sowieso im Hintergrund läuft. Bei dieser Methode 
startet man ein update Request bei dem man die Rahmenbedingungen wie Priorität min und max Zeit zwischen den Updates einstellen kann.
Diese Methode ist Akkuschonender.

Fusion Location Provider
Diese Methode ist im prinziep eine verbesserte und vereinfachte Form des Fusion Location Client und wird von Google empfohlen.

\subsubsection{Entfernung bestimmen}
Die bestimmten Positionen werden gesammelt bis das Aufzeichnen der Fahrt beendet wird. 
Um die zurückgelegte Entfernung zu bestimmen, muss die Entfernung zwischen den einzelnen Punkten bestimmt werden.
Dafür hat die Klasse 'Location' schon die Funktion 'distanceTo(Location)'.
Ein Codeausschnitt um die Entfernung zu bestimmten könnte wie folgt aussehen

```
fun getDistance(locations: List<Location>): Int {
	for (l in locations.indices) {
		if (l + 1 < locations.size)
			distance += locations[l].distanceTo(locations[l + 1])
	}
	return distance.toInt() / 1000 //meter to kilometer
}
```

\subsubsection{Start- und Zieladresse ermitteln}
Bevor man die Fahrt in die Datenbank schreiben kann benötigt man außer den GPS-Koordinaten, Ankunftszeit, Abfahrtszeit und 
Entfernung auch die Adresse der ersten und letzten Position. Um diese zu ermitteln benötigt man eine API die eine GPS-Position 
entgegennimmt und eine Adresse zurückgibt. Da ich eh schon die Google Maps API verwende, habe ich mich für Geocoding entschieden.
Das ist eine Google API die genau das macht, GPS-Kordinaten einer Adresse zuordnen und umgekehrt. 

\subsubsection{Foreground Service}
Um das Aufzeichnen der Fahrt sollte auch funktionieren wenn die App nicht im Vordergrund läuft.
Deswegen sollte das Aufzeichnen der Fahrt im Hintergrund laufen.
Seit Android Oreo gibt es Einschränkungen für "Background Threads" und "Backmground Location Limits". 
Diese besagen das wenn man die Position mehr als ein paar mal pro Stunde Abfragt, dann ist das nur in einem
'Foreground Service' möglich. Außerdem wurden 'Foreground Services' auch limitiert, diese haben nach dem start 5 Sekunden
Zeit eine Notifaction anzuzeigen sonst werden diese vom System gekillt.

\subsubsection{Darstellung der Fahrt auf Karte}
In der Detailansicht sollte es eine Karte geben auf der die Start und Zielposition bei hinzugefügten Fahrten angezeigt werden
und bei aufgezeichneten Fahrten außerdem noch der Weg. Für die Darstellung auf der Karte werde ich die Google Maps SDK verwenden.
Die Start und Zieladresse werden als Marker dargestellt. Bei einer aufgezeichneten Fahrt wird dann noch eine Verbindungslinie 
zwischen allen erfassten Position, mithilfe von 'Polylines'. 
Das hinzufügen eines Markes und Polylienes könnte dann wie folgt ausschauen.

```
map.addMarker(
	MarkerOptions()
		.position(destinationLatLng).title(getString(R.string.destinationAddress) + ": " + destination.address)
)

if (routes != null) {	# wenn es GPS-Position zwischen Start und Zieladresse gibt
	val options = PolylineOptions().width(8f)
		.color(ContextCompat.getColor(applicationContext, R.color.colorPrimaryDark))

	routes.forEach {
		options.add(it) 
	}
	map.addPolyline(options)
}
```


\subsection{Bluetooth}
Die App soll das aufzeichnen Automatisch starten wenn eine Bluetoothverbindung aufgebaut wird.
Dafür benötige ich einen Brodcastreciever der getriggert wird wenn eine Bluetoothverbindung aufgebaut oder beendet wird.
Das auslößen eines Recievers wenn eine Bluetoothverbindung aufgebaut wird geschieht über "android.bluetooth.device.action.ACL_CONNECTED".
und das beim beenden einer Bluetoothverbindung über "android.bluetooth.device.action.ACL_DISCONNECTED"  


```
<receiver android:name=".receiver.StartActivityOnBluetooth">
<intent-filter>
	<action android:name="android.bluetooth.device.action.ACL_CONNECTED"/>
	<action android:name="android.bluetooth.device.action.ACL_DISCONNECTED"/>
</intent-filter>
</receiver>
```

\subsection{NFC}
Meine App ist nach dem MVVM Pattern und dem Single-Activity-Pattern aufgebaut

\subsubsection{MVVM}
Das steht für Model, ViewModel, View. 

\subsection{Einstellungen}
Der Benutzer soll die Möglichkeit haben einzustellen wann er Benachrichtigt
gespeichert in den Shared Prefernces

\subsection{View}

\section{Architectur}
Da ich die App auch gern in Zukunft weiter entwicklen möchte wollte ich die App so moder wie möglich gestalten.
....
Android Jetpack
....


\section{Features}

\subsection{Kernfeatures}
Diese Features müssen auf jeden Fall umgesetzt werden, damit man die App benutzen kann. 
\begin{enumerate}
	\item Alle Fahrten werden in einer Liste angezeigt.
	\item Es gibt eine Detailansicht für jede Fahrt.
	\item Bei aufgezeichneten Fahrten muss es in der Detailansicht noch eine Karte mit dem eingezeichneten Weg geben.
	\item Man muss einzelne Fahrten löschen können
\end{enumerate}

\subsection{Features}
\begin{enumerate}
	\item Einträge editieren
	\item Einträge als Email expotieren.
	\item Die Email ist so formatiert das man den Text der Email einfach in Excel einfügen kann.
	\item Alle Einträge vor einem bestimmten Datum löschen.
	\item Benachrichtigung als Erinnerung, dass man die Einträge in sein Fahrtenbuch übernimmt.
	\item Anpassbare Listenübersicht, man kann selbst bestimmen welche Informationen angezeigt werden.
	\item Die App startet das aufzeichen Automatisch wenn man sich per Bluetooth mit dem Auto verbindet.
	\item Man kann den Kilometerstand korrektgieren.
	\item Man kann in den Einstellungen den Tag und den Abstand bestimmen in dem man Benachrichtigt wird.
	\item Wenn man einen Eintrag löscht werden die Kilometerstände aller neueren Einträge um die Distanz des gelöschten Eintrags verringert.
\end{enumerate}

\subsection{Anforderungen}

\begin{enumerate}
	\item Die Fahrtenbuch Daten sollen in einer Datenbank auf dem Handy gespeichert werden.
	\item Alle Einträge der Datenbank sollen in einer Liste dargestellt werden.
	\item Die Liste enthält die Information Zeit, Zweck, Start, Ziel
	\item Die Liste kann man nach Datum sotieren.
	\item Der Benutzer kann in der Liste suchen.
	\item Der Benutzer kann auf ein Element der Liste klicken und bekommt eine Detailansicht.
	\item Die App speichert die Daten in der Form wir die vom Finanzamt anerkannten Fahrtenbücher.
	\item Die App muss per GPS erfassen wenn der Benutzer losfährt und automatisch Start-, Endpunkt und Entfernung bestimmen und diese eintragen.
	\item Die App muss den Benutzer Auffordern fehlende Information, wie \enquote{Zweck der Fahrt nachzutragen}.
	\item Der Benutzer muss Fahrten in der App händisch eintragen können.
	\item Der Benutzer muss alle Fahrtenbuch Daten expotieren können als PDF oder HTML(bzw. Jason).
	\item Die App soll automatisch starten wenn das Handy per Blutooth mit dem Auto gekoppelt wird.
	\item Der Benutzer soll Einträge bearbeiten können.
	\item Der Benutzer soll Einträge löschen können.
\end{enumerate}

\section{User Stories, Personas}

\section{Mockuop, Wireframe}

\begin{figure}
	\begin{minipage}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{img/mock1}
        \caption{\label{img:img/mock1}, Startbildschirm}
    \end{minipage}
    \hspace{0.025\textwidth}% Abstand zwischen Bilder
	\begin{minipage}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{img/mock2}
        \caption{\label{img:img/mock2}Driverslog Pro 2 - Fahrtenbuch, Detailansicht}
    \end{minipage}
    \hspace{0.025\textwidth}% Abstand zwischen Bilder
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{img/mock3}
        \caption{\label{img:img/mock3}Driverslog Pro 2 - Fahrtenbuch, Detailansicht}
	\end{minipage}
\end{figure}

\begin{figure}
	\begin{minipage}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{img/mock4}
        \caption{\label{img:img/mock4}, Startbildschirm}
    \end{minipage}
    \hspace{0.025\textwidth}% Abstand zwischen Bilder
	\begin{minipage}[b]{0.3\textwidth}
        \includegraphics[width=\textwidth]{img/mock5}
        \caption{\label{img:img/mock5}Driverslog Pro 2 - Fahrtenbuch, Detailansicht}
    \end{minipage}
    \hspace{0.025\textwidth}% Abstand zwischen Bilder
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{img/mock6}
        \caption{\label{img:img/mock6}Driverslog Pro 2 - Fahrtenbuch, Detailansicht}
	\end{minipage}
\end{figure}

\section{UML-Diagramme}

\section{Code Dokumentation}

\section{Fazit}

\section{Aufwand}

\end{document}